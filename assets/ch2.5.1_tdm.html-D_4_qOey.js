import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as e,o as m,c as i,a as s,d as a,b as t,e as r}from"./app-SD3SAAIy.js";const p={},c=r('<h2 id="背景和目的" tabindex="-1"><a class="header-anchor" href="#背景和目的"><span>背景和目的</span></a></h2><p>召回早前经历的第一代协同过滤技术，让模型可以在数量级巨大的item集中找到用户潜在想要看到的商品。这种方式有很明显的缺点，一个是对于用户而言，只能通过他历史行为去构建候选集，并且会基于算力的局限做截断。所以推荐结果的多样性和新颖性比较局限，导致推荐的有可能都是用户看过的或者买过的商品。之后在Facebook开源了faiss库之后，基于内积模型的向量检索方案得到了广泛应用，也就是第二代召回技术。这种技术通过将用户和物品用向量表示，然后用内积的大小度量兴趣，借助向量索引实现大规模的全量检索。这里虽然改善了第一代的无法全局检索的缺点，然而这种模式下存在索引构建和模型优化目标不一致的问题，索引优化是基于向量的近似误差，而召回问题的目标是最大化topK召回率。且这类方法也不方便在用户和物品之间做特征组合。</p><p>所以阿里开发了一种可以承载各种深度模型来检索用户潜在兴趣的推荐算法解决方案。这个TDM模型是基于树结构，利用树结构对全量商品进行检索，将复杂度由O(N)下降到O(logN)。</p><h3 id="faiss库" tabindex="-1"><a class="header-anchor" href="#faiss库"><span>Faiss库</span></a></h3><p>Faiss是一个高效地稠密向量相似检索和聚类的工具包，由Facebook开发，由C++编写，并且提供了python2和python3的封装。</p><h4 id="什么是相似检索" tabindex="-1"><a class="header-anchor" href="#什么是相似检索"><span>什么是相似检索？</span></a></h4><p>给定一个向量集合，Faiss可以建立一个数据结构。这个数据结构建立完成之后，当给定一个向量x，它可以高效地查找出与x距离最近的向量。在Faiss的术语中，这个数据结构被称为索引(index)，寻找最近向量这个过程，就是在索引上的搜索操作。 总的来说，Faiss实现了如下功能：</p><ul><li>不仅仅返回距离最近的向量，也能够返回第二近，第三近的向量，...，第K近的向量</li><li>可以同时批量查找多个向量（batch processing），在大多数索引类型中，这种方式都比一个个查找要快</li><li>在精确性和执行速度上醉了平衡，比如，给出了10%的错误结果，但是运行速度快了10倍或者仅仅占用了1/10的内存</li><li>在搜索时，使用的是最大内积（inner product）搜索，而不是最小欧式距离搜索</li><li>返回查询点给定范围内的所有元素，范围搜索（range serach） # 入门 Faiss用来处理向量的集合，假设向量的纬度是d，这些向量的集合可以存储在矩阵中。Faiss在使用时用的是32位的浮点数，这点要注意。</li></ul><h2 id="模型结构" tabindex="-1"><a class="header-anchor" href="#模型结构"><span>模型结构</span></a></h2><h3 id="树结构" tabindex="-1"><a class="header-anchor" href="#树结构"><span>树结构</span></a></h3><div align="center"><img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/图片image-20220420213149324.png" alt="image-20210308142624189" style="zoom:15%;"></div><p>如上图，树中的每一个叶子节点对应一个商品item，非叶子结点表示的是item的集合（<strong>这里的树不限于二叉树</strong>）。这种层次化结构体现了粒度从粗到细的item架构。</p><h3 id="整体结构" tabindex="-1"><a class="header-anchor" href="#整体结构"><span>整体结构</span></a></h3><div align="center"><img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/图片image-20220420200433442.png" alt="image-20210308142624189" style="zoom:70%;"></div><h2 id="算法详解" tabindex="-1"><a class="header-anchor" href="#算法详解"><span>算法详解</span></a></h2>',15),h=s("ol",null,[s("li",null,[s("p",null,"基于树的高效检索"),s("p",null,"算法通常采用beam-search的方法，根据用户对每层节点挑选出topK，将挑选出来的这几个topK节点的子节点作为下一层的候选集，最终会落到叶子节点上。 这么做的理论依据是当前层的最有优topK节点的父亲必然属于上次的父辈节点的最优topK："),s("p",{class:"katex-block"},[s("span",{class:"katex-display"},[s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[s("semantics",null,[s("mrow",null,[s("msup",null,[s("mi",null,"p"),s("mrow",null,[s("mo",{stretchy:"false"},"("),s("mi",null,"j"),s("mo",{stretchy:"false"},")")])]),s("mo",{stretchy:"false"},"("),s("mi",null,"n"),s("mi",{mathvariant:"normal"},"∣"),s("mi",null,"u"),s("mo",{stretchy:"false"},")"),s("mo",null,"="),s("mfrac",null,[s("mrow",null,[s("mfrac",{linethickness:"0px"},[s("mrow",null,[s("mi",null,"m"),s("mi",null,"a"),s("mi",null,"x")]),s("mrow",null,[s("msub",null,[s("mi",null,"n"),s("mi",null,"c")]),s("mo",null,"∈"),s("mrow",null,[s("mo",{stretchy:"false"},"{"),s("msup",null,[s("mi",null,"n"),s("mo",{mathvariant:"normal",lspace:"0em",rspace:"0em"},"′")]),s("mi",null,"s"),s("mi",null,"c"),s("mi",null,"h"),s("mi",null,"i"),s("mi",null,"l"),s("mi",null,"d"),s("mi",null,"r"),s("mi",null,"e"),s("mi",null,"n"),s("mi",null,"n"),s("mi",null,"o"),s("mi",null,"d"),s("mi",null,"e"),s("mi",null,"s"),s("mi",null,"i"),s("mi",null,"n"),s("mi",null,"l"),s("mi",null,"e"),s("mi",null,"v"),s("mi",null,"e"),s("mi",null,"l"),s("mi",null,"j"),s("mo",null,"+"),s("mn",null,"1"),s("mo",{stretchy:"false"},"}")])])]),s("msup",null,[s("mi",null,"p"),s("mrow",null,[s("mo",{stretchy:"false"},"("),s("mi",null,"j"),s("mo",null,"+"),s("mn",null,"1"),s("mo",{stretchy:"false"},")")])]),s("mo",{stretchy:"false"},"("),s("msub",null,[s("mi",null,"n"),s("mi",null,"c")]),s("mi",{mathvariant:"normal"},"∣"),s("mi",null,"u"),s("mo",{stretchy:"false"},")")]),s("msup",null,[s("mi",null,"α"),s("mi",null,"j")])])]),s("annotation",{encoding:"application/x-tex"}," p^{(j)}(n|u) = {{max \\atop{n_{c}\\in{\\{n's children nodes in level j+1\\}}}}p^{(j+1)}(n_{c}|u) \\over {\\alpha^{j}}} ")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1.188em","vertical-align":"-0.25em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"p"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.938em"}},[s("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mopen mtight"},"("),s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),s("span",{class:"mclose mtight"},")")])])])])])])])]),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal"},"n"),s("span",{class:"mord"},"∣"),s("span",{class:"mord mathnormal"},"u"),s("span",{class:"mclose"},")"),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),s("span",{class:"mrel"},"="),s("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),s("span",{class:"base"},[s("span",{class:"strut",style:{height:"2.484em","vertical-align":"-0.686em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mopen nulldelimiter"}),s("span",{class:"mfrac"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"1.798em"}},[s("span",{style:{top:"-2.314em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.0037em"}},"α"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.7507em"}},[s("span",{style:{top:"-2.989em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])])])])])])])]),s("span",{style:{top:"-3.23em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"frac-line",style:{"border-bottom-width":"0.04em"}})]),s("span",{style:{top:"-3.91em"}},[s("span",{class:"pstrut",style:{height:"3em"}}),s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mord"},[s("span",{class:"mopen nulldelimiter"}),s("span",{class:"mfrac"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.7454em"}},[s("span",{style:{top:"-2.355em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"n"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.1645em"}},[s("span",{style:{top:"-2.357em","margin-left":"0em","margin-right":"0.0714em"}},[s("span",{class:"pstrut",style:{height:"2.5em"}}),s("span",{class:"sizing reset-size3 size1 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"c")])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.143em"}},[s("span")])])])])]),s("span",{class:"mrel mtight"},"∈"),s("span",{class:"mord mtight"},[s("span",{class:"mopen mtight"},"{"),s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"n"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.6828em"}},[s("span",{style:{top:"-2.786em","margin-right":"0.0714em"}},[s("span",{class:"pstrut",style:{height:"2.5em"}}),s("span",{class:"sizing reset-size3 size1 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mtight"},"′")])])])])])])])]),s("span",{class:"mord mathnormal mtight"},"sc"),s("span",{class:"mord mathnormal mtight"},"hi"),s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.01968em"}},"l"),s("span",{class:"mord mathnormal mtight"},"d"),s("span",{class:"mord mathnormal mtight"},"re"),s("span",{class:"mord mathnormal mtight"},"nn"),s("span",{class:"mord mathnormal mtight"},"o"),s("span",{class:"mord mathnormal mtight"},"d"),s("span",{class:"mord mathnormal mtight"},"es"),s("span",{class:"mord mathnormal mtight"},"in"),s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.01968em"}},"l"),s("span",{class:"mord mathnormal mtight"},"e"),s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.03588em"}},"v"),s("span",{class:"mord mathnormal mtight"},"e"),s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.01968em"}},"l"),s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),s("span",{class:"mbin mtight"},"+"),s("span",{class:"mord mtight"},"1"),s("span",{class:"mclose mtight"},"}")])])])]),s("span",{style:{top:"-3.144em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"ma"),s("span",{class:"mord mathnormal mtight"},"x")])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.52em"}},[s("span")])])])]),s("span",{class:"mclose nulldelimiter"})])]),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"p"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.888em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mopen mtight"},"("),s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),s("span",{class:"mbin mtight"},"+"),s("span",{class:"mord mtight"},"1"),s("span",{class:"mclose mtight"},")")])])])])])])])]),s("span",{class:"mopen"},"("),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"n"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.1514em"}},[s("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight"},"c")])])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mord"},"∣"),s("span",{class:"mord mathnormal"},"u"),s("span",{class:"mclose"},")")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.686em"}},[s("span")])])])]),s("span",{class:"mclose nulldelimiter"})])])])])])])]),s("p",null,[a("其中"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("msup",null,[s("mi",null,"p"),s("mrow",null,[s("mo",{stretchy:"false"},"("),s("mi",null,"j"),s("mo",{stretchy:"false"},")")])]),s("mo",{stretchy:"false"},"("),s("mi",null,"n"),s("mi",{mathvariant:"normal"},"∣"),s("mi",null,"u"),s("mo",{stretchy:"false"},")")]),s("annotation",{encoding:"application/x-tex"},"p^{(j)}(n|u)")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"1.138em","vertical-align":"-0.25em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"p"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.888em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mopen mtight"},"("),s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),s("span",{class:"mclose mtight"},")")])])])])])])])]),s("span",{class:"mopen"},"("),s("span",{class:"mord mathnormal"},"n"),s("span",{class:"mord"},"∣"),s("span",{class:"mord mathnormal"},"u"),s("span",{class:"mclose"},")")])])]),a("表示用户u对j层节点n感兴趣的概率，"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("msup",null,[s("mi",null,"α"),s("mi",null,"j")])]),s("annotation",{encoding:"application/x-tex"},"\\alpha^{j}")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8247em"}}),s("span",{class:"mord"},[s("span",{class:"mord mathnormal",style:{"margin-right":"0.0037em"}},"α"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.8247em"}},[s("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mtight"},[s("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])])])])])])])])]),a("表示归一化因子。")])]),s("li",null,[s("p",null,"对兴趣进行建模"),s("div",{align:"center"},[s("img",{src:"http://ryluo.oss-cn-chengdu.aliyuncs.com/图片image-20220420214040264.png",alt:"image-20210308142624189",style:{zoom:"50%"}})]),s("p",null,"​如上图，用户对叶子层item6感兴趣，可以认为它的兴趣是1，同层别的候选节点的兴趣为0，顺着着绿色线路上去的节点都标记为1，路线上的同层别的候选节点都标记为0。这样的操作就可以根据1和0构建用于每一层的正负样本。"),s("p",null,[a("样本构建完成后，可以在模型结构左侧采用任意的深度学习模型来承担用户兴趣判别器的角色，输入就是当前层构造的正负样本，输出则是（用户，节点）对的兴趣度，这个将被用作检索过程中选取topK的评判指标。"),s("strong",null,"在整体结构图中，我们可以看到节点特征方面，使用的是node embedding"),a("，说明在进入模型前已经向量化了。")])]),s("li",null,[s("p",null,"训练过程"),s("div",{align:"center"},[s("img",{src:"http://ryluo.oss-cn-chengdu.aliyuncs.com/图片image-20220420220831318.png",alt:"image-20210308142624189",style:{zoom:"15%"}})]),s("p",null,"整体联合训练的方式如下："),s("ol",null,[s("li",null,"构造随机二叉树"),s("li",null,"基于树模型生成样本"),s("li",null,"训练DNN模型直到收敛"),s("li",null,"基于DNN模型得到样本的Embedding，重新构造聚类二叉树"),s("li",null,"循环上述2～4过程")]),s("p",null,"​具体的，在初始化树结构的时候，首先借助商品的类别信息进行排序，将相同类别的商品放到一起，然后递归的将同类别中的商品等量的分到两个子类中，直到集合中只包含一项，利用这种自顶向下的方式来初始化一棵树。基于该树采样生成深度模型训练所需的样本，然后进一步训练模型，训练结束之后可以得到每个树节点对应的Embedding向量，利用节点的Embedding向量，采用K-Means聚类方法来重新构建一颗树，最后基于这颗新生成的树，重新训练深层网络。")])],-1),o=s("h2",{id:"参考资料",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#参考资料"},[s("span",null,"参考资料")])],-1),g={href:"https://mp.weixin.qq.com/s/sw16_sUsyYuzpqqy39RsdQ",target:"_blank",rel:"noopener noreferrer"},u={href:"https://zhuanlan.zhihu.com/p/78941783",target:"_blank",rel:"noopener noreferrer"},d={href:"https://zhuanlan.zhihu.com/p/93201318",target:"_blank",rel:"noopener noreferrer"},y={href:"https://github.com/PaddlePaddle/PaddleRec/blob/master/models/treebased/README.md",target:"_blank",rel:"noopener noreferrer"};function v(f,b){const l=e("ExternalLinkIcon");return m(),i("div",null,[c,h,o,s("ul",null,[s("li",null,[s("a",g,[a("阿里妈妈深度树检索技术(TDM) 及应用框架的探索实践"),t(l)])]),s("li",null,[s("a",u,[a("阿里TDM：Tree-based Deep Model"),t(l)])]),s("li",null,[s("a",d,[a("阿里妈妈TDM模型详解"),t(l)])]),s("li",null,[s("a",y,[a("Paddle TDM 模型实现"),t(l)])])])])}const _=n(p,[["render",v],["__file","ch2.5.1_tdm.html.vue"]]),k=JSON.parse('{"path":"/rcmd/ch02/ch2.5/ch2.5.1_tdm.html","title":"阿里：TDM模型","lang":"zh-CN","frontmatter":{"date":"2024-06-18T00:00:00.000Z","title":"阿里：TDM模型","shortTitle":"TDM模型","author":"Genhiy","order":1,"category":["推荐系统"],"tag":["无标签"],"feed":false,"seo":false,"head":[]},"headers":[{"level":2,"title":"背景和目的","slug":"背景和目的","link":"#背景和目的","children":[{"level":3,"title":"Faiss库","slug":"faiss库","link":"#faiss库","children":[]}]},{"level":2,"title":"模型结构","slug":"模型结构","link":"#模型结构","children":[{"level":3,"title":"树结构","slug":"树结构","link":"#树结构","children":[]},{"level":3,"title":"整体结构","slug":"整体结构","link":"#整体结构","children":[]}]},{"level":2,"title":"算法详解","slug":"算法详解","link":"#算法详解","children":[]},{"level":2,"title":"参考资料","slug":"参考资料","link":"#参考资料","children":[]}],"git":{},"readingTime":{"minutes":5.55,"words":1664},"filePathRelative":"rcmd/ch02/ch2.5/ch2.5.1_tdm.md","localizedDate":"2024年6月18日"}');export{_ as comp,k as data};
